{{template "layout" .}}

{{define "title"}}{{.Title}} - Admin{{end}}

{{define "extra-nav"}}
    {{if eq .Visibility "public"}}
    <a href="/entry/{{.Path}}" target="_blank">View Public Page</a>
    {{end}}
{{end}}

{{define "content"}}
    <div class="edit-container">
        <!-- Hidden input for optimistic locking -->
        <input type="hidden" id="updated-at" name="updated_at" value="{{.UpdatedAt}}" />

        <div class="edit-main">
            <!-- Title Input -->
            <div class="title-section">
                <input
                    type="text"
                    name="title"
                    value="{{.Title}}"
                    placeholder="Entry Title"
                    class="title-input"
                    hx-post="/admin/entries/title?path={{.Path}}"
                    hx-trigger="keyup changed delay:500ms"
                    hx-target="#save-feedback"
                    hx-swap="innerHTML"
                    hx-include="#updated-at"
                />
            </div>

            <!-- Body Editor (CodeMirror 6) -->
            <div class="body-section">
                <div id="editor-container" class="editor-container"></div>
                <script id="initial-body" type="application/json">{{.Body | js}}</script>
            </div>
        </div>

        <div class="edit-sidebar">
            <!-- Save Feedback -->
            <div id="save-feedback" class="save-feedback"></div>

            <!-- Visibility Control -->
            <div class="control-panel">
                <h3>Visibility</h3>
                <div class="visibility-control">
                    <label class="radio-label">
                        <input
                            type="radio"
                            name="visibility"
                            value="private"
                            {{if eq .Visibility "private"}}checked{{end}}
                            hx-post="/admin/entries/visibility?path={{.Path}}"
                            hx-target="#save-feedback"
                            hx-confirm="Change visibility to private?"
                        />
                        <span>Private</span>
                    </label>
                    <label class="radio-label">
                        <input
                            type="radio"
                            name="visibility"
                            value="public"
                            {{if eq .Visibility "public"}}checked{{end}}
                            hx-post="/admin/entries/visibility?path={{.Path}}"
                            hx-target="#save-feedback"
                            hx-confirm="Change visibility to public?"
                        />
                        <span>Public</span>
                    </label>
                </div>
            </div>

            <!-- Actions -->
            <div class="control-panel">
                <h3>Actions</h3>
                <button
                    class="btn btn-danger"
                    hx-delete="/admin/entries/delete?path={{.Path}}"
                    hx-confirm="Are you sure you want to delete this entry? This action cannot be undone.">
                    ðŸ—‘ Delete Entry
                </button>
                <button
                    class="btn btn-secondary"
                    hx-post="/admin/entries/image/regenerate?path={{.Path}}"
                    hx-target="#save-feedback"
                    hx-swap="innerHTML">
                    ðŸ”„ Regenerate Image
                </button>
            </div>
        </div>
    </div>
{{end}}

{{define "extra-scripts"}}
<script type="module">
import { createEditor, getContent, insertAtCursor } from '/admin/static/codemirror-bundle.js';

(function() {
    // Listen for updated_at changes from server (optimistic locking)
    document.body.addEventListener('updatedAtChanged', function(evt) {
        const newUpdatedAt = evt.detail.value;
        const hiddenInput = document.getElementById('updated-at');
        if (hiddenInput && newUpdatedAt) {
            hiddenInput.value = newUpdatedAt;
        }
    });

    // Initialize CodeMirror editor
    const container = document.getElementById('editor-container');
    const initialBodyScript = document.getElementById('initial-body');
    if (!container || !initialBodyScript) return;

    const initialBody = JSON.parse(initialBodyScript.textContent);

    const editor = createEditor(container, initialBody, (content) => {
        // Auto-save on content change
        const updatedAt = document.getElementById('updated-at').value;
        htmx.ajax('POST', '/admin/entries/body?path={{.Path}}', {
            target: '#save-feedback',
            swap: 'innerHTML',
            values: { body: content, updated_at: updatedAt }
        });
    });

    // Store editor reference globally for image paste
    window.blog4Editor = editor;

    // Handle image paste in CodeMirror
    container.addEventListener('paste', async (event) => {
        const items = event.clipboardData?.items || [];
        const imageFiles = [];

        for (const item of items) {
            if (item.kind === 'file' && item.type.startsWith('image/')) {
                const file = item.getAsFile();
                if (file) imageFiles.push(file);
            }
        }

        if (imageFiles.length === 0) return;
        event.preventDefault();

        for (const file of imageFiles) {
            await uploadAndInsertImage(file);
        }
    });

    async function uploadAndInsertImage(file) {
        try {
            const formData = new FormData();
            formData.append('file', file);

            const response = await fetch('/admin/entries/upload', {
                method: 'POST',
                body: formData,
            });

            if (!response.ok) {
                throw new Error(`Upload failed: ${response.statusText}`);
            }

            const data = await response.json();

            if (data.error) {
                showError(data.error);
                return;
            }

            if (!data.url) {
                throw new Error('No URL in response');
            }

            // Insert markdown image at cursor
            const markdownImage = `![image](${data.url})`;
            insertAtCursor(editor, markdownImage);

            // Trigger auto-save
            const updatedAt = document.getElementById('updated-at').value;
            htmx.ajax('POST', '/admin/entries/body?path={{.Path}}', {
                target: '#save-feedback',
                swap: 'innerHTML',
                values: { body: getContent(editor), updated_at: updatedAt }
            });

            showSuccess('Image uploaded successfully');
        } catch (error) {
            console.error('Upload error:', error);
            showError(`Failed to upload image: ${error.message}`);
        }
    }

    function showSuccess(message) {
        const feedback = document.getElementById('save-feedback');
        if (feedback) {
            feedback.innerHTML = `<div class="feedback-success">${message}</div>`;
            setTimeout(() => feedback.innerHTML = '', 3000);
        }
    }

    function showError(message) {
        const feedback = document.getElementById('save-feedback');
        if (feedback) {
            feedback.innerHTML = `<div class="feedback-error">${message}</div>`;
            setTimeout(() => feedback.innerHTML = '', 5000);
        }
    }
})();
</script>
{{end}}
