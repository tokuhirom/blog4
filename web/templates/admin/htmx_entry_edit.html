{{template "layout" .}}

{{define "title"}}{{.Title}} - Admin{{end}}

{{define "extra-css"}}<link rel="stylesheet" href="/admin/static/entry-edit.css">{{end}}

{{define "extra-nav"}}
    {{if eq .Visibility "public"}}
    <a href="/entry/{{.Path}}" target="_blank">View Public Page</a>
    {{end}}
{{end}}

{{define "content"}}
    <div class="edit-container">
        <div class="edit-main">
            <!-- Title Input -->
            <div class="title-section">
                <input
                    type="text"
                    name="title"
                    value="{{.Title}}"
                    placeholder="Entry Title"
                    class="title-input"
                    hx-post="/admin/entries/title?path={{.Path}}"
                    hx-trigger="keyup changed delay:500ms"
                    hx-target="#save-feedback"
                    hx-swap="innerHTML"
                />
            </div>

            <!-- Body Editor -->
            <div class="body-section">
                <textarea
                    name="body"
                    placeholder="Write your markdown here..."
                    class="body-textarea"
                    hx-post="/admin/entries/body?path={{.Path}}"
                    hx-trigger="keyup changed delay:800ms"
                    hx-target="#save-feedback"
                    hx-swap="innerHTML"
                >{{.Body}}</textarea>
            </div>
        </div>

        <div class="edit-sidebar">
            <!-- Save Feedback -->
            <div id="save-feedback" class="save-feedback"></div>

            <!-- Visibility Control -->
            <div class="control-panel">
                <h3>Visibility</h3>
                <div class="visibility-control">
                    <label class="radio-label">
                        <input
                            type="radio"
                            name="visibility"
                            value="private"
                            {{if eq .Visibility "private"}}checked{{end}}
                            hx-post="/admin/entries/visibility?path={{.Path}}"
                            hx-target="#save-feedback"
                            hx-confirm="Change visibility to private?"
                        />
                        <span>Private</span>
                    </label>
                    <label class="radio-label">
                        <input
                            type="radio"
                            name="visibility"
                            value="public"
                            {{if eq .Visibility "public"}}checked{{end}}
                            hx-post="/admin/entries/visibility?path={{.Path}}"
                            hx-target="#save-feedback"
                            hx-confirm="Change visibility to public?"
                        />
                        <span>Public</span>
                    </label>
                </div>
            </div>

            <!-- Actions -->
            <div class="control-panel">
                <h3>Actions</h3>
                <button
                    class="btn btn-danger"
                    hx-delete="/admin/entries/delete?path={{.Path}}"
                    hx-confirm="Are you sure you want to delete this entry? This action cannot be undone.">
                    üóë Delete Entry
                </button>
                <button
                    class="btn btn-secondary"
                    hx-post="/admin/entries/image/regenerate?path={{.Path}}"
                    hx-target="#save-feedback"
                    hx-swap="innerHTML">
                    üîÑ Regenerate Image
                </button>
            </div>
        </div>
    </div>
{{end}}

{{define "extra-scripts"}}
<script>
(function() {
    const textarea = document.querySelector('.body-textarea');
    if (!textarea) return;

    textarea.addEventListener('paste', async (event) => {
        const items = event.clipboardData?.items || [];
        const imageFiles = [];

        for (const item of items) {
            if (item.kind === 'file' && item.type.startsWith('image/')) {
                const file = item.getAsFile();
                if (file) imageFiles.push(file);
            }
        }

        if (imageFiles.length === 0) return;
        event.preventDefault();

        for (const file of imageFiles) {
            await uploadAndInsertImage(textarea, file);
        }
    });

    async function uploadAndInsertImage(textarea, file) {
        try {
            const formData = new FormData();
            formData.append('file', file);

            const response = await fetch('/admin/entries/upload', {
                method: 'POST',
                body: formData,
            });

            if (!response.ok) {
                throw new Error(`Upload failed: ${response.statusText}`);
            }

            const data = await response.json();

            if (data.error) {
                showError(data.error);
                return;
            }

            if (!data.url) {
                throw new Error('No URL in response');
            }

            // Markdown„Çí„Ç´„Éº„ÇΩ„É´‰ΩçÁΩÆ„Å´ÊåøÂÖ•
            const cursorPos = textarea.selectionStart;
            const before = textarea.value.substring(0, cursorPos);
            const after = textarea.value.substring(cursorPos);
            const markdownImage = `![image](${data.url})`;

            textarea.value = before + markdownImage + after;

            // „Ç´„Éº„ÇΩ„É´ÁßªÂãï
            textarea.focus();
            const newCursorPos = cursorPos + markdownImage.length;
            textarea.setSelectionRange(newCursorPos, newCursorPos);

            // HTMXÁµåÁî±„ÅßËá™Âãï‰øùÂ≠ò
            htmx.ajax('POST', '/admin/entries/body?path={{.Path}}', {
                target: '#save-feedback',
                swap: 'innerHTML',
                values: {body: textarea.value}
            });

            showSuccess('Image uploaded successfully');
        } catch (error) {
            console.error('Upload error:', error);
            showError(`Failed to upload image: ${error.message}`);
        }
    }

    function showSuccess(message) {
        const feedback = document.getElementById('save-feedback');
        if (feedback) {
            feedback.innerHTML = `<div class="feedback-success">${message}</div>`;
            setTimeout(() => feedback.innerHTML = '', 3000);
        }
    }

    function showError(message) {
        const feedback = document.getElementById('save-feedback');
        if (feedback) {
            feedback.innerHTML = `<div class="feedback-error">${message}</div>`;
            setTimeout(() => feedback.innerHTML = '', 5000);
        }
    }
})();
</script>
{{end}}
